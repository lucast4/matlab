function lt_neural_NGRAMS_PlotScatter(OUTSTRUCT, SummaryStruct, plottype, plotON, ...
    PairtypesToplot, dosubtractcontrol, sanitycheckuseneg, plotRawGood, usemedian)
%%
assert(sum([plotRawGood plotON])<2, 'cannot do both types of raw plots ...');

%% for globalz
useGlobalNeg = 0; % if 0, then just neg for the desired pairs. default: 1

%% LT 4/24/18 - plots scatter (i.e. mean for pairtype 2 vs. 1)


%% INPUTS

% plottype = 'absfrdiff';
% oneminusrho - 1 minus correlation coefficient of smoothed FR
% absfrdiff - diff in FR, each pair/unit normalized (z) versus its own
% shuffle control
% absfrdiff_globZ - mean abs diff in FR, normalized versus global
% distribtuion of neg control shuffles

% plotON=0; % only works for absfrdiff
% PairtypesToplot = {...
%     '1  1  1', ... % xaxis
%     '1  0  0'}; % yaxis
%
% % ----------- params for one minus rho, specifically
% dosubtractcontrol = 1; % then subtracts negative control before plotting [if 0, then overlays neg]
% sanitycheckuseneg = 0; % uses negative control data instead of data


%% pull out data
% ========================== FOR COMPATIBILITY WITH OLD CODE, EXTRACT ALL
% FIELDS
fnamesthis = fieldnames(OUTSTRUCT);
for j=1:length(fnamesthis)
    eval([fnamesthis{j} ' = OUTSTRUCT.' fnamesthis{j} ';']);
end

%%
numpairtypes = length(PairtypesToplot);
maxbirds = max(All_birdnum);
maxneur = max(All_neurnum);

pcolors = lt_make_plot_colors(numpairtypes, 0,0);


%%
figcount=1;
subplotrows=5;
subplotcols=3;
fignums_alreadyused=[];
hfigs=[];
hsplots = [];

% =====================
AllPairs_Means = [];
AllPairs_Bregions = {};
AllPairs_Birdnum = [];
for i=1:maxbirds
    birdname = SummaryStruct.birds(i).birdname;
    for ii=1:maxneur
        
        inds = All_birdnum==i & All_neurnum==ii;
        
        if ~any(inds)
            continue
        end
        
        % -- brainregion
        bregion = SummaryStruct.birds(i).neurons(ii).NOTE_Location;
        allmeans = nan(1,numpairtypes);
        
        if strcmp(plottype, 'oneminusrho')
            % ========= plot
            [fignums_alreadyused, hfigs, figcount, hsplot]=lt_plot_MultSubplotsFigs('', subplotrows, subplotcols, fignums_alreadyused, hfigs, figcount);
            title([birdname '-n' num2str(ii) '[' bregion ']']);
            
            AllRhoNeg = [];
            for k =1:numpairtypes
                
                pairtypethis = PairtypesToplot{k};
                pairtypethis = find(strcmp(PairTypesInOrder, pairtypethis));
                
                inds = All_birdnum==i & All_neurnum==ii & All_diffsyl_PairType==pairtypethis;
                
                % ========= collect data
                pairtype = All_diffsyl_PairType(inds);
                oneminusrho_neg = All_OneMinusRho_NEG(inds);
                oneminusrho = All_OneMinusRho(inds);
                
                if sanitycheckuseneg==1
                    oneminusrho = oneminusrho_neg;
                end
                
                % ----- subtract negative control?
                if dosubtractcontrol==1
                    oneminusrho = oneminusrho - oneminusrho_neg;
                end
                
                % =============== plot histograms
                xcenters = 0.05:0.1:1.95;
                if dosubtractcontrol==1
                    xcenters = -1.15:0.1:1.95;
                end
                lt_plot_histogram(oneminusrho, xcenters, 1, 1, '', 1, pcolors{k});
                
                
                % ================ collect mean to then do scatterplot
                ymean = mean(oneminusrho);
                allmeans(k) = ymean;
                
                % ======== collect negative distribution
                AllRhoNeg = [AllRhoNeg; oneminusrho_neg];
            end
            
            % ======== collect each neuron
            AllPairs_Means = [AllPairs_Means; allmeans];
            AllPairs_Bregions = [AllPairs_Bregions; bregion];
            AllPairs_Birdnum = [AllPairs_Birdnum; i];
            
            % ======== overlay negative distribution
            if dosubtractcontrol==0
                lt_plot_histogram(AllRhoNeg, xcenters, 1, 1, '', 1, [0.7 0.7 0.7]);
            end
            
            
        else
            %%
            if plotON==1
                [fignums_alreadyused, hfigs, figcount, hsplot]=lt_plot_MultSubplotsFigs('', subplotrows, subplotcols, fignums_alreadyused, hfigs, figcount);
                title([birdname '-n' num2str(ii) '[' bregion ']']);
            end
            
            YplotAll = cell(1,3); % dat1, dat2, neg control
            MotifPairString = cell(1,3);
            for k =1:numpairtypes
                
                pairtypethis = PairtypesToplot{k};
                pairtypethis = find(strcmp(PairTypesInOrder, pairtypethis));
                
                inds = All_birdnum==i & All_neurnum==ii & All_diffsyl_PairType==pairtypethis;
                
                
                % ########################################## COLLECT DATA
                y = [];
                if strcmp(plottype, 'absfrdiff')
                    % then mean abs diff in FR, normalized within each
                    % pairtype
                    y = All_AbsFRdiff_Zrelshuff(inds);
                    
                elseif strcmp(plottype, 'absfrdiff_globZ')
                    % =========== version with both dat and pos compared to
                    % distribution of negative controls
                    
                    % ----- V1 - NEG = combined from the pairs being analyzed
                    if useGlobalNeg==0 % old version, limited to just the desired pairs. but I think
                        % is better to use all pairs ...
                        [~, pairtypes_neg] = intersect(PairTypesInOrder, PairtypesToplot);
                        indsneg = All_birdnum==i & All_neurnum==ii & ...
                            ismember(All_diffsyl_PairType, pairtypes_neg);
                    elseif useGlobalNeg==1
                        indsneg = All_birdnum==i & All_neurnum==ii;
                    end
                    
                    
                    negmean = mean(All_AbsFRdiff_NEG(indsneg));
                    negstd = std(All_AbsFRdiff_NEG(indsneg));
                    
                    y = (All_AbsFRdiff(inds) - negmean)./negstd;
                    
                    % ================= OUTPUT FOR PLOTTING
                    YplotAll{k} = All_AbsFRdiff(inds);
                    YplotAll{3} = [YplotAll{3} All_AbsFRdiff_NEG(inds)]; % collect negative controls
                elseif strcmp(plottype, 'absfrdiff_typediff')
                    
                    % ----- V2 - each type compaired to mean of its own neg
                    % (not zscored)
                    y = All_AbsFRdiff(inds) - mean(All_AbsFRdiff_NEG(inds));
                    
                end
                
                % ==================== COLLECT MOTIF NAMES
                motifpairlist = OUTSTRUCT.All_ngramstring_inorder(inds,:);
                MotifPairString{k} = motifpairlist;
                
                
                % ###################################### PLOT HISTOGRAMS?
                if plotON==1
                    % =============== plot histograms
                    lt_plot_histogram(y, '', 1, 1, '', 1, pcolors{k});
                end
                
                
                % #################### collect mean to then do scatterplot
                if usemedian==1
                    ymean = median(y);
                else
                    ymean = mean(y);
                end
                allmeans(k) = ymean;
            end
            
            % ======== collect each neuron
            AllPairs_Means = [AllPairs_Means; allmeans];
            AllPairs_Bregions = [AllPairs_Bregions; bregion];
            AllPairs_Birdnum = [AllPairs_Birdnum; i];
            
        end
        
        % =============================== PLOT,
        if plotRawGood==1 & strcmp(plottype, 'absfrdiff_globZ')
            
            % rthen can plot!!
            [fignums_alreadyused, hfigs, figcount, hsplot]=lt_plot_MultSubplotsFigs('', subplotrows, subplotcols, fignums_alreadyused, hfigs, figcount);
            title([birdname '-n' num2str(ii) '[' bregion ']']);
            
            lt_plot_MultDist(YplotAll, [1 2 3], 0, 'k', 0)
            lt_plot_zeroline;
            
            if (0) % old version, plotting histograms , but is too crowded...
                
                xcenters = min(cell2mat(YplotAll)):0.1:max(cell2mat(YplotAll));
                
                % ----- NEG
                indtmp = 3;
                pcol = [0.7 0.6 0.7];
                lt_plot_histogram(YplotAll{indtmp}, xcenters, 1, 1, '', 1, pcol);
                % ----- POS
                indtmp = 1;
                pcol = [0.3 0.3 0.9];
                lt_plot_histogram(YplotAll{indtmp}, xcenters, 1, 1, '', 1, pcol);
                % ----- DAT
                indtmp = 2;
                pcol = 'k';
                lt_plot_histogram(YplotAll{indtmp}, xcenters, 1, 1, 0.2, 0, pcol);
            end
        end
        
    end
end

%% =========== PLOT SCATTER COMPARING TWO CLASSES ACROSS ALL NEURONS
if strcmp(plottype, 'oneminusrho')
    lt_figure; hold on;
    % ----- LMAN
    lt_subplot(2,2,1); hold on;
    title('LMAN');
    indstmp = strcmp(AllPairs_Bregions, 'LMAN');
    xlabel(PairtypesToplot{1});
    ylabel(PairtypesToplot{2});
    
    y = AllPairs_Means(indstmp, :);
    plot(y(:,1), y(:,2), 'ok');
    xlim([-1 1]);
    ylim([-1 1]);
    lt_plot_zeroline;
    lt_plot_zeroline_vert;
    line([-1 1], [-1 1]);
    
    % ----- RA
    lt_subplot(2,2,2); hold on;
    title('RA');
    indstmp = strcmp(AllPairs_Bregions, 'RA');
    xlabel(PairtypesToplot{1});
    ylabel(PairtypesToplot{2});
    
    y = AllPairs_Means(indstmp, :);
    plot(y(:,1), y(:,2), 'ok');
    xlim([-1 1]);
    ylim([-1 1]);
    lt_plot_zeroline;
    lt_plot_zeroline_vert;
    line([-1 1], [-1 1]);
    
    % --- COMBINED
    lt_subplot(2,2,3); hold on;
    % LMAN
    indstmp = strcmp(AllPairs_Bregions, 'LMAN');
    y = AllPairs_Means(indstmp, :);
    plot(y(:,1), y(:,2), 'ob');
    
    % RA
    indstmp = strcmp(AllPairs_Bregions, 'RA');
    y = AllPairs_Means(indstmp, :);
    plot(y(:,1), y(:,2), 'or');
    
    % FORMATING
    xlabel(PairtypesToplot{1});
    ylabel(PairtypesToplot{2});
    
    xlim([-1 1]);
    ylim([-1 1]);
    lt_plot_zeroline;
    lt_plot_zeroline_vert;
    line([-1 1], [-1 1]);
    
    
    % ============ SAPRATE BY BIRD
    maxbirds = max(AllPairs_Birdnum);
    for j=1:maxbirds
        lt_figure; hold on;
        
        % LMAN
        indstmp = strcmp(AllPairs_Bregions, 'LMAN') & AllPairs_Birdnum==j;
        y = AllPairs_Means(indstmp, :);
        plot(y(:,1), y(:,2), 'ob');
        
        % RA
        indstmp = strcmp(AllPairs_Bregions, 'RA') & AllPairs_Birdnum==j;
        y = AllPairs_Means(indstmp, :);
        plot(y(:,1), y(:,2), 'or');
        
        % FORMATING
        xlabel(PairtypesToplot{1});
        ylabel(PairtypesToplot{2});
        
        xlim([-1 1]);
        ylim([-1 1]);
        lt_plot_zeroline;
        lt_plot_zeroline_vert;
        line([-1 1], [-1 1]);
        
        
        
    end
else
    figcount=1;
    subplotrows=6;
    subplotcols=3;
    fignums_alreadyused=[];
    hfigs=[];
    hsplots = [];
    
    
    maxbirds = max(AllPairs_Birdnum);
    for j=1:maxbirds
        [fignums_alreadyused, hfigs, figcount, hsplot]=lt_plot_MultSubplotsFigs('', subplotrows, subplotcols, fignums_alreadyused, hfigs, figcount);
        title([SummaryStruct.birds(j).birdname]);
        hsplots = [hsplots hsplot];
        % LMAN
        indstmp = strcmp(AllPairs_Bregions, 'LMAN') & AllPairs_Birdnum==j;
        y = AllPairs_Means(indstmp, :);
        plot(y(:,1), y(:,2), 'ob');
        
        % RA
        indstmp = strcmp(AllPairs_Bregions, 'RA') & AllPairs_Birdnum==j;
        y = AllPairs_Means(indstmp, :);
        plot(y(:,1), y(:,2), 'or');
        
        % FORMATING
        xlabel(PairtypesToplot{1});
        ylabel(PairtypesToplot{2});
        
        %         xlim([-1 1]);
        %         ylim([-1 1]);
        
        lt_plot_makesquare_plot45line(gca, 'k', -2);
    end
    
    
    % ============ ONE PLOT ALL BIRDS
    [fignums_alreadyused, hfigs, figcount, hsplot]=lt_plot_MultSubplotsFigs('', subplotrows, subplotcols, fignums_alreadyused, hfigs, figcount);
    title(['ALL BIRDS']);
    hsplots = [hsplots hsplot];
    % LMAN
    indstmp = strcmp(AllPairs_Bregions, 'LMAN');
    y = AllPairs_Means(indstmp, :);
    plot(y(:,1), y(:,2), 'ob');
    
    % RA
    indstmp = strcmp(AllPairs_Bregions, 'RA');
    y = AllPairs_Means(indstmp, :);
    plot(y(:,1), y(:,2), 'or');
    
    % FORMATING
    xlabel(PairtypesToplot{1});
    ylabel(PairtypesToplot{2});
    
    %         xlim([-1 1]);
    %         ylim([-1 1]);
    
    lt_plot_makesquare_plot45line(gca, 'k', -2);
    linkaxes(hsplots, 'xy');
    
    
    % #################3 SAME JUST MY BIRDS
    
    
end


%% ========== ancova,
if (0)
    indstmp = AllPairs_Birdnum==6;
    y1 = AllPairs_Means(indstmp, 1);
    y2 = AllPairs_Means(indstmp, 2);
    group = AllPairs_Bregions(indstmp);
    
    aoctool(y1, y2, group)
end

%% ====== OVERLAY DISTRIBUTIONS FOR ALL BIRDS
lt_figure; hold on;
title('each bird one fill col (circle(RA), sqiare(L)');
maxbirds = max(AllPairs_Birdnum);
plotcols = lt_make_plot_colors(maxbirds, 0,0);
xlabel(PairtypesToplot{1});
ylabel(PairtypesToplot{2});
for j=1:maxbirds
    
    % ======= fill with color?
    if length(unique(AllPairs_Bregions(AllPairs_Birdnum==j)))>1
        % then color, since multiple brain regions
        pcol = plotcols{j};
    else
        pcol = [1 1 1];
    end
    
    % ============ LMAN
    indstmp = strcmp(AllPairs_Bregions, 'LMAN') & AllPairs_Birdnum==j;
    y = AllPairs_Means(indstmp, :);
    % get mean and sem in 2 dimensions
    ymean = mean(y,1);
    ysem_x = lt_sem(y(:,1));
    ysem_y = lt_sem(y(:,2));
    
    plot(ymean(1), ymean(2), 's', 'MarkerFaceColor', pcol, ...
        'Color', 'b', 'MarkerSize', 8);
    
    % =============== RA
    indstmp = strcmp(AllPairs_Bregions, 'RA') & AllPairs_Birdnum==j;
    y = AllPairs_Means(indstmp, :);
    % get mean and sem in 2 dimensions
    ymean = mean(y,1);
    ysem_x = lt_sem(y(:,1));
    ysem_y = lt_sem(y(:,2));
    
    plot(ymean(1), ymean(2), 'o','MarkerFaceColor', pcol, ...
        'Color', 'r', 'MarkerSize', 8);
    
    lt_plot_makesquare_plot45line(gca, 'k', -2);
end


%% ================= FOR EACH NEURON, DIVIDE DATA INTO POS CONTROL

AllPairs_Ratios = AllPairs_Means(:,2)./AllPairs_Means(:,1);

% ====================== PLOT, each bird compare LMAN and RA
figcount=1;
subplotrows=5;
subplotcols=3;
fignums_alreadyused=[];
hfigs=[];
hsplots = [];


maxbirds = max(AllPairs_Birdnum);
for j=1:maxbirds
    [fignums_alreadyused, hfigs, figcount, hsplot]=lt_plot_MultSubplotsFigs('', subplotrows, subplotcols, fignums_alreadyused, hfigs, figcount);
    title([SummaryStruct.birds(j).birdname]);
    hsplots = [hsplots hsplot];
    
    Y = {};
    % LMAN
    indstmp = strcmp(AllPairs_Bregions, 'LMAN') & AllPairs_Birdnum==j;
    Y{1} = AllPairs_Ratios(indstmp, :);
    
    % LMAN
    indstmp = strcmp(AllPairs_Bregions, 'RA') & AllPairs_Birdnum==j;
    Y{2} = AllPairs_Ratios(indstmp, :);
    
    % === plot
    lt_plot_MultDist(Y, [1 2], 1);
    
    % FORMATING
    ylabel([PairtypesToplot{2} '/' PairtypesToplot{1}])
    xlabel('LMAN -- RA');
    xlim([0 3]);
    
end

% ============ grand mean
[fignums_alreadyused, hfigs, figcount, hsplot]=lt_plot_MultSubplotsFigs('', subplotrows, subplotcols, fignums_alreadyused, hfigs, figcount);
title('ALL BIRDS');
hsplots = [hsplots hsplot];

Y = {};
% LMAN
indstmp = strcmp(AllPairs_Bregions, 'LMAN');
Y{1} = AllPairs_Ratios(indstmp, :);

% LMAN
indstmp = strcmp(AllPairs_Bregions, 'RA');
Y{2} = AllPairs_Ratios(indstmp, :);

% === plot
lt_plot_MultDist(Y, [1 2], 1);

% FORMATING
ylabel([PairtypesToplot{2} '/' PairtypesToplot{1}])
xlabel('LMAN -- RA');
xlim([0 3]);


linkaxes(hsplots, 'y');


% ###########################33 COMBINE ALL IN ONE PLOT
lt_figure; hold on;
title('[dat - neg]/[pos - neg]');
ylabel([PairtypesToplot{2} '/' PairtypesToplot{1}])
xlabel('Birds (LMAN -- RA)');

maxbirds = max(AllPairs_Birdnum);
for j=1:maxbirds
    
    % LMAN
    pcol = 'b';
    x = j*3-2;
    indstmp = strcmp(AllPairs_Bregions, 'LMAN') & AllPairs_Birdnum==j;
    if any(indstmp)
        lt_plot_MultDist({AllPairs_Ratios(indstmp, :)}, x, 0, pcol);
    end
    
    % RA
    pcol = 'r';
    x = j*3-1;
    indstmp = strcmp(AllPairs_Bregions, 'RA') & AllPairs_Birdnum==j;
    if any(indstmp)
        lt_plot_MultDist({AllPairs_Ratios(indstmp, :)}, x, 0, pcol);
    end
    
    line(3*[j j], ylim, 'Color', 'k' ,'LineStyle', '--');
end
lt_plot_zeroline;


%% ====== LINEAR MODEL TESTING WHETHER SLOPE DEPENDS ON BREGION

y1 = AllPairs_Means(:,1);
y2 = AllPairs_Means(:,2);
tbl = table(y1, y2, AllPairs_Birdnum, AllPairs_Bregions, 'VariableNames', ...
    {'y1', 'y2', 'birdnum', 'bregion'});

mdl = 'y2 ~ y1 + bregion:y1 + (-1 + y1|birdnum) + (-1+bregion:y1|birdnum)';  % full model
% mdl = 'y1 ~ y2 + bregion:y2 + (-1 + y2|birdnum) + (-1+bregion:y2|birdnum)';  % full model
lme = fitlme(tbl, mdl)


%% =========== SAME, BUT RESTRICTED TO BIRDS WITH BOTH DATA
goodbirds = intersect(AllPairs_Birdnum(strcmp(AllPairs_Bregions, 'LMAN')) ,...
    AllPairs_Birdnum(strcmp(AllPairs_Bregions, 'RA')));
indsgood = ismember(AllPairs_Birdnum, goodbirds');

y1 = AllPairs_Means(:,1);
y2 = AllPairs_Means(:,2);
tbl = table(y1(indsgood), y2(indsgood), AllPairs_Birdnum(indsgood), AllPairs_Bregions(indsgood), 'VariableNames', ...
    {'y1', 'y2', 'birdnum', 'bregion'});

mdl = 'y2 ~ y1 + bregion:y1 + (-1 + y1|birdnum) + (-1+bregion:y1|birdnum)';  % full model
lme = fitlme(tbl, mdl)


%% =========== SAME, BUT RESTRICTED TO BIRDS THAT I RECORDED
% -------- FIND THE GOOD BIRDS
goodbirds = [];
for j=1:length(SummaryStruct.birds)
    if isfield(SummaryStruct.birds(j).neurons(1), 'isRAsobermel')
        continue
    else
        % -- then is my bird
        goodbirds = [goodbirds j];
    end
end
disp({SummaryStruct.birds(goodbirds).birdname});

% ------- INDS FOR THESE BIRDS
indsgood = ismember(AllPairs_Birdnum, goodbirds);

y1 = AllPairs_Means(:,1);
y2 = AllPairs_Means(:,2);
tbl = table(y1(indsgood), y2(indsgood), AllPairs_Birdnum(indsgood), AllPairs_Bregions(indsgood), 'VariableNames', ...
    {'y1', 'y2', 'birdnum', 'bregion'});

mdl = 'y2 ~ y1 + bregion:y1 + (-1 + y1|birdnum) + (-1+bregion:y1|birdnum)';  % full model
lme = fitlme(tbl, mdl)

%% =============== SAME, BUT DO MODEL FOR SINGLE BIRD
birdtodo = 'wh44wh39';
goodbirds = [];
for j=1:length(SummaryStruct.birds)
    if ~strcmp(SummaryStruct.birds(j).birdname, birdtodo)
        continue
    else
        % -- then is my bird
        goodbirds = [goodbirds j];
    end
end
goodbirds = find(strcmp({SummaryStruct.birds.birdname}, birdtodo));

% ------- INDS FOR THESE BIRDS
indsgood = ismember(AllPairs_Birdnum, goodbirds);

% -----
y1 = AllPairs_Means(:,1);
y2 = AllPairs_Means(:,2);
tbl = table(y1(indsgood), y2(indsgood), AllPairs_Birdnum(indsgood), AllPairs_Bregions(indsgood), 'VariableNames', ...
    {'y1', 'y2', 'birdnum', 'bregion'});

mdl = 'y2 ~ y1 + bregion:y1';  % full model
lme = fitlme(tbl, mdl)
